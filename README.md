# sc-scheduling

Simple library to schedule events in Node.js and the browser.

<!-- toc -->

- [Install](#install)
- [Example Use](#example-use)
- [Notes](#notes)
- [Terminology](#terminology)
- [API](#api)
  * [Table of Contents](#table-of-contents)
- [SchedulerInfos](#schedulerinfos)
  * [tickLookahead](#ticklookahead)
- [Scheduler](#scheduler)
  * [Parameters](#parameters)
  * [period](#period)
  * [lookahead](#lookahead)
  * [currentTime](#currenttime)
  * [audioTime](#audiotime)
  * [has](#has)
  * [defer](#defer)
  * [add](#add)
  * [reset](#reset)
  * [remove](#remove)
  * [clear](#clear)
- [License](#license)

<!-- tocstop -->

## Install

```
npm install --save @ircam/sc-scheduling
```

## Example Use

```js
import { Scheduler } from '@ircam/sc-scheduling';

const audioContext = new AudioContext();
// create a scheduler in the timeline of the audio context
const scheduler = new Scheduler(() => audioContext.currentTime);
// schedule an audio event to be scheduler every seconds
schedule.add(currentTime => {
  doSomethingAtCurrentTime(currentTime);
  // ask to be called back in 1 second from currentTime
  return currentTime + 1;
});
```

## Notes

_This library is still under development_

For now, only the `Scheduler` class can be considered stable, other abstractions like `Transport` can change at any time

## Terminology

- `time` refers to the timeline of the parent
- `position` refers to the timeline of the children

- `Transport` is the thing that control timelines or engines with play / pause / etc.
- `Timeline` is an abstraction that can host abstractions and place them in time according to each others

## API

<!-- api -->
<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [SchedulerInfos][1]
    *   [tickLookahead][2]
*   [Scheduler][3]
    *   [Parameters][4]
    *   [period][5]
    *   [lookahead][6]
    *   [currentTime][7]
    *   [audioTime][8]
    *   [has][9]
    *   [defer][10]
    *   [add][11]
    *   [reset][12]
    *   [remove][13]
    *   [clear][14]

## SchedulerInfos

Scheduler information provided as third argument of a callback registered
in the scheduler

### tickLookahead

Delta time between tick time and current time, in seconds

Type: [Number][15]

## Scheduler

The `Scheduler` interface implements a lookahead scheduler that can be used to
schedule events in an arbitrary timelines.
It aims at finding a tradeoff between time precision, real-time responsiveness
and the weaknesses of the native timers (i.e. `setTimeout` and `setInterval`)

For an in-depth explaination of the pattern, see [https://web.dev/audio-scheduling/][16]

### Parameters

*   `getTimeFunction` **[function][17]** A function which return a time in seconds
    that will define the timeline of the scheduler.
*   `$1` **[Object][18]**  (optional, default `{}`)

    *   `$1.period`   (optional, default `0.025`)
    *   `$1.lookahead`   (optional, default `0.1`)
    *   `$1.queueSize`   (optional, default `1e3`)
    *   `$1.currentTimeToAudioTimeFunction`   (optional, default `identity`)
    *   `$1.maxEngineRecursion`   (optional, default `100`)
    *   `$1.verbose`   (optional, default `false`)
*   `options` **[object][18]** Options of the scheduler

### period

Period at which the scheduler checks for events, in seconds.
Throws if negative or greater than lookahead.

Type: [number][15]

### lookahead

Lookahead duration in seconds.
Throws if negative or lower than period.

Type: [number][15]

### currentTime

Scheduler current logical time.

Type: [number][15]

### audioTime

Scheduler current audio time according to `currentTime`

Type: [number][15]

### has

Check whether a given engine has been added to this scheduler

#### Parameters

*   `engine` **[object][18]** Engine to test.

Returns **[boolean][19]**&#x20;

### defer

Execute a function once at a given time,

Calling `defer` compensates with a `setTimeout` for the tick lookahead
introduced by the scheduling. Can be usefull for example to synchronize
audio events which natively scheduled with visuals which have no internal
timing/scheduling ability.

Be aware that this method will introduce small timing error (order of 1-2ms)
due to the `setTimeout`.

#### Parameters

*   `callback` **[function][17]** Callback function to schedule.
*   `time` **[number][15]** Time at which the callback should be scheduled.

#### Examples

```javascript
const scheduler = new Scheduler(getTime);

scheduler.add((currentTime, audioTime) => {
  // schedule some audio event
  playSomeSoundAt(audioTime);
  // defer execution of visual display to compensate the dt
  scheduler.defer(displaySomeSynchronizedStuff, currentTime);
  // ask the scheduler to call back in 1 second
  return currentTime + 1;
});
```

### add

Add a time engine to the scheduler.

#### Parameters

*   `engine` **[function][17]** Engine to add to the schduler
*   `time` **[number][15]** Time at which the engine should be launched. The
    provided value is clamped to `currentTime` (optional, default `0`)

### reset

Reset next time of a given engine.

If time is not a number, the engine is removed from the scheduler.

Be aware that calling this method within an engine callback function won't
work, because the reset will be overriden by the engine return value.

#### Parameters

*   `engine` **[function][17]** The engine to reschedule
*   `time` **[number][15]** Time at which the engine must be rescheduled (optional, default `undefined`)

### remove

Remove a time engine from the scheduler.

#### Parameters

*   `engine` **[function][17]** The engine to reschedule

### clear

Clear the scheduler.

[1]: #schedulerinfos

[2]: #ticklookahead

[3]: #scheduler

[4]: #parameters

[5]: #period

[6]: #lookahead

[7]: #currenttime

[8]: #audiotime

[9]: #has

[10]: #defer

[11]: #add

[12]: #reset

[13]: #remove

[14]: #clear

[15]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[16]: https://web.dev/audio-scheduling/

[17]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[18]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[19]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

<!-- apistop -->

## License

[BSD-3-Clause](./LICENSE)
